<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml"
                creationComplete="dataLoader.send();"
                xmlns:controls="org.juicekit.visual.controls.*"
                fontFamily="Arial" 
                color="#333333"
                paddingTop="10"
                backgroundGradientColors="[0xffffff, 0xffffff]">

  <mx:Script>
    <![CDATA[
      import flare.vis.data.NodeSprite;
      import org.juicekit.events.DataMouseEvent;
      import org.juicekit.util.data.GraphUtil;
      import mx.rpc.http.HTTPService;
      import mx.rpc.events.ResultEvent;
      import flare.util.Strings;
      import flare.query.methods.*;
      import flare.data.converters.DelimitedTextConverter;


      public function resultHandler(event:ResultEvent):void {
        var d:Array = new DelimitedTextConverter(',').parse(event.result as String).nodes.data;
        /*
           The data looks like this:

           STATE,SEX,AGE,POP2000,POP2008
           Alabama,M,0,30479,32055
           Alabama,M,1,29904,32321
           Alabama,M,2,30065,31789
           Alabama,M,3,29932,31371
           Alabama,M,4,30319,31164
           Alabama,M,5,31127,31049
           Alabama,M,6,31466,30960
         */

        treemap.data = GraphUtil.treeMap(d, ['AGE', 'SEX', 'STATE'], ['POP2000', 'POP2008',
          // Percentage change in population from 2000 to 2008.
          // change = (POP2008 - POP2000) / POP2000
          {change: pctchange('POP2008', 'POP2000')}],
          function(o:Object):Boolean {
            return (o.AGE >= 20 && o.AGE <= 40)
          });

        treemap.addEventListener(DataMouseEvent.MOUSE_OVER, function(e:DataMouseEvent):void {
            if ((e.dataSprite as NodeSprite).childDegree == 0) {
              selectedNode.htmlText = Strings.format("<b>State:</b> {0}<br/>" + "<b>Sex:</b> {1}<br/>" + "<b>Age:</b> {2}<br/>" + "<b>Pop. in 2000:</b> {3:#,##0}<br/>" + "<b>Pop. in 2008:</b> {4:#,##0} (size)<br/>" + "<b>Change:</b> {5:0.0%} (color)", e.data.STATE, e.data.SEX, e.data.AGE, e.data.POP2000, e.data.POP2008, e.data.change);
            }
          });
        treemap.addEventListener(DataMouseEvent.MOUSE_OUT, function(e:DataMouseEvent):void {
            selectedNode.text = '';
          });

      }
    ]]>
  </mx:Script>

  <mx:HTTPService id="dataLoader"
                  url="http://media.juiceanalytics.com/census/CENSUS_STATEAGESEX.csv"
                  method="GET"
                  showBusyCursor="true"
                  result="resultHandler(event)"
                  resultFormat="text"/>

  <mx:VBox verticalGap="0">
    <mx:Label text="Population Growth by Age, Gender, and State"
              fontSize="18"
              color="#333333"
              fontWeight="bold"/>
    <mx:Label text="This demo illustrates the features of the JuiceKit treemap. Source: US Census Bureau"
              fontSize="12"
              color="#666666"/>
    <mx:Spacer height="10"/>

    <mx:HBox>
      <mx:Label text="Color by:"/>
      <mx:ComboBox id="colorCmb" selectedIndex="0" dataProvider="['change', 'POP2000', 'POP2008']"/>
      <mx:Label text="Size by:"/>
      <mx:ComboBox id="sizeCmb" selectedIndex="0" dataProvider="['POP2000', 'POP2008']"/>
      <mx:Label text="Color palette:"/>
      <mx:ComboBox id="paletteCmb"
                   selectedIndex="0"
                   dataProvider="['hot', 'summer', 'cool', 'Purples', 'YlGn', 'RdGy', 'PuOr']"
                   itemRenderer="PaletteRenderer"
                   dropdownWidth="200"
                   rowCount="8"/>
    </mx:HBox>
    <mx:Spacer height="10"/>
    
    <controls:TreeMapZoomControl tree="{treemap}" fontSize="16" color="#333333"/>
    <mx:HBox width="960">
      <controls:TreeMapControl id="treemap"
                               width="700"
                               height="600"
                               transitionPeriod="1.2"
                               palette="{paletteCmb.selectedItem}"
                               colorEncodingField="{colorCmb.selectedItem}"
                               sizeEncodingField="{sizeCmb.selectedItem}"
                               styleFromDataRoot="true"
                               fontSize="16"
                               labelEncodingField="name"
                               labelColorStrategy="glow"
                               truncateToFit="true"
                               strokeColors="[0xffffff, 0xffffff, 0xffffff, 0x333333]"
                               strokeThicknesses="[0,8,3,0.25]"/>

      <mx:Text id="selectedNode" text="" fontSize="14" width="250"/>
    </mx:HBox>
  </mx:VBox>

</mx:Application>
